name: datadog-service-catalog-provider

on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:

  # check-if-service-datadog-yaml-file-changed:
  #   runs-on: ubuntu-latest
  #   name: Test changed-files
  #   steps:
  #     - uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0
      
  #     - name:Check if service.datadog.yaml file is changed
  #       id: changed-files
  #       uses: tj-actions/changed-files@v38
  #       with:
  #         files: service.datadog.yaml
      
  #     - name: Cancel run if service.datadog.yaml file is unchanged 
  #       if: steps.changed-files.outputs.any_changed != 'true'
  #       shell: bash
  #       run: while true; do echo "Waiting for job to be cancelled"; sleep 5; done


  update-DD-service-catalog:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3
        
      - id: dd-overall-data
        name: Getting service data from service.datadog.yaml
        uses: mikefarah/yq@master 
        with:
          cmd: yq '.' 'service.datadog.yaml'   

      - name: Check if dd-service output is working
        run: echo "${{ steps.dd-overall-data.outputs.result }}"

      - name: Set env variables for each service catalog 
        shell: bash
        run: |
          DATA = ${{ steps.dd-overall-data.outputs.result }}
          for line in $DATA
          do
            echo $line
          done

      # - uses: arcxp/datadog-service-catalog-metadata-provider@v2
      #   name: Update datadog service catalog metadata with new metadata
      #   with:
      #     schema-version: v2.1
      #     datadog-hostname: api.us5.datadoghq.com
      #     datadog-key: ${{ secrets.DATADOG_API_KEY }}
      #     datadog-app-key: ${{ secrets.DATADOG_APP_KEY }}

      #     service-name: ${{ steps.dd-service.outputs.result }}
      #     team: ${{ steps.dd-team.outputs.result }}
      #     application: ${{ steps.dd-application.outputs.result}}
      #     description: ${{ steps.dd-description.outputs.result }}
      #     lifecycle: ${{ steps.dd-lifecycle.outputs.result }}
      #     tier: ${{ steps.dd-tier.outputs.result }}
      #     email: ${{ steps.dd-contacts-email.outputs.result }}
      #     slack-support-channel: ${{ steps.dd-contacts-slack.outputs.result }}

      #     contacts: |
      #       ${{ steps.service-datadog-yaml.outputs.result.contacts }}

      #     links: |
      #       ${{ steps.dd-links.outputs.result }}
            
      #     integrations: |
      #       ${{ steps.dd-integrations.outputs.result }}
          